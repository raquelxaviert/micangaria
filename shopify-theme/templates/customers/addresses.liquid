{% comment %}
  Customer addresses template for miçangaria
{% endcomment %}

<div class="container py-12">
  <!-- Page Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="headline text-primary mb-2" style="font-size: 2rem;">Meus Endereços</h1>
      <p class="text-muted-foreground">Gerencie seus endereços de entrega</p>
    </div>
    
    <div class="flex" style="gap: 0.75rem;">
      <a href="/account" class="btn-outline">
        <i data-lucide="arrow-left" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
        Voltar
      </a>
      <button onclick="showAddressForm()" class="btn-primary">
        <i data-lucide="plus" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
        Adicionar Endereço
      </button>
    </div>
  </div>

  <!-- Success/Error Messages -->
  {% if form.posted_successfully? %}
    <div class="alert alert-success mb-6">
      <i data-lucide="check-circle" style="width: 1.25rem; height: 1.25rem;"></i>
      <div>
        <p style="margin: 0; font-weight: 500;">Endereço salvo com sucesso!</p>
      </div>
    </div>
  {% endif %}

  {% if form.errors %}
    <div class="alert alert-destructive mb-6">
      <i data-lucide="alert-circle" style="width: 1.25rem; height: 1.25rem;"></i>
      <div>
        <p style="margin: 0; font-weight: 500;">Erro ao salvar endereço</p>
        <ul style="margin: 0.25rem 0 0; font-size: 0.875rem; padding-left: 1rem;">
          {% for error in form.errors %}
            <li>{{ error | first | capitalize }}: {{ error | last }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <div class="grid grid-cols-1 lg-grid-cols-3" style="gap: 2rem;">
    <!-- Addresses List -->
    <div class="lg-col-span-2">
      {% if customer.addresses.size > 0 %}
        <div class="grid grid-cols-1 md-grid-cols-2" style="gap: 1.5rem;">
          {% for address in customer.addresses %}
            <div class="card address-card" data-address-id="{{ address.id }}">
              <!-- Default Badge -->
              {% if address == customer.default_address %}
                <div class="flex items-center justify-between mb-4">
                  <span class="badge" style="background: hsl(var(--primary)); color: white;">
                    <i data-lucide="star" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;"></i>
                    Endereço Principal
                  </span>
                </div>
              {% endif %}

              <!-- Address Details -->
              <div class="mb-4">
                <h3 class="font-medium text-foreground mb-2">
                  {{ address.first_name }} {{ address.last_name }}
                </h3>
                <div class="text-sm text-muted-foreground space-y-1">
                  <p>{{ address.address1 }}</p>
                  {% if address.address2 != blank %}
                    <p>{{ address.address2 }}</p>
                  {% endif %}
                  <p>{{ address.city }}, {{ address.province }} {{ address.zip }}</p>
                  <p>{{ address.country }}</p>
                  {% if address.phone != blank %}
                    <p class="mt-2">Tel: {{ address.phone }}</p>
                  {% endif %}
                </div>
              </div>

              <!-- Actions -->
              <div class="flex" style="gap: 0.5rem;">
                <button 
                  onclick="editAddress({{ address.id }})"
                  class="btn-outline flex-1 text-center"
                  style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                >
                  <i data-lucide="edit" style="width: 0.875rem; height: 0.875rem; margin-right: 0.25rem;"></i>
                  Editar
                </button>
                
                {% unless address == customer.default_address %}
                  <button 
                    onclick="deleteAddress({{ address.id }})"
                    class="btn-outline text-destructive border-destructive hover-bg-destructive hover-text-white"
                    style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                  >
                    <i data-lucide="trash-2" style="width: 0.875rem; height: 0.875rem;"></i>
                  </button>
                {% endunless %}
                
                {% unless address == customer.default_address %}
                  <form action="/account/addresses/{{ address.id }}/default" method="post" style="display: inline;">
                    <button 
                      type="submit"
                      class="btn-outline"
                      style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                      title="Definir como principal"
                    >
                      <i data-lucide="star" style="width: 0.875rem; height: 0.875rem;"></i>
                    </button>
                  </form>
                {% endunless %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
          <i data-lucide="map-pin" style="width: 4rem; height: 4rem; color: hsl(var(--muted-foreground)); margin: 0 auto 1rem;"></i>
          <h2 class="headline text-foreground mb-2" style="font-size: 1.5rem;">Nenhum endereço cadastrado</h2>
          <p class="text-muted-foreground mb-6">
            Adicione um endereço para facilitar suas compras futuras.
          </p>
          <button onclick="showAddressForm()" class="btn-primary">
            <i data-lucide="plus" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
            Adicionar Primeiro Endereço
          </button>
        </div>
      {% endif %}
    </div>

    <!-- Address Form -->
    <div class="address-form-container" id="addressForm" style="display: none;">
      <div class="card">
        <div class="flex items-center justify-between mb-6">
          <h2 class="headline text-foreground" style="font-size: 1.25rem;" id="formTitle">Novo Endereço</h2>
          <button onclick="hideAddressForm()" class="text-muted-foreground hover-text-foreground">
            <i data-lucide="x" style="width: 1.5rem; height: 1.5rem;"></i>
          </button>
        </div>

        {% form 'customer_address', customer.new_address %}
          <div class="space-y-4">
            <div class="grid grid-cols-1 md-grid-cols-2" style="gap: 1rem;">
              <div>
                <label for="address_first_name" class="label">Nome *</label>
                <input 
                  type="text" 
                  id="address_first_name"
                  name="address[first_name]"
                  class="input"
                  value="{{ form.first_name }}"
                  required
                >
              </div>
              <div>
                <label for="address_last_name" class="label">Sobrenome *</label>
                <input 
                  type="text" 
                  id="address_last_name"
                  name="address[last_name]"
                  class="input"
                  value="{{ form.last_name }}"
                  required
                >
              </div>
            </div>

            <div>
              <label for="address_company" class="label">Empresa</label>
              <input 
                type="text" 
                id="address_company"
                name="address[company]"
                class="input"
                value="{{ form.company }}"
              >
            </div>

            <div>
              <label for="address_address1" class="label">Endereço *</label>
              <input 
                type="text" 
                id="address_address1"
                name="address[address1]"
                class="input"
                value="{{ form.address1 }}"
                placeholder="Rua, número"
                required
              >
            </div>

            <div>
              <label for="address_address2" class="label">Complemento</label>
              <input 
                type="text" 
                id="address_address2"
                name="address[address2]"
                class="input"
                value="{{ form.address2 }}"
                placeholder="Apartamento, bloco, etc."
              >
            </div>

            <div class="grid grid-cols-1 md-grid-cols-2" style="gap: 1rem;">
              <div>
                <label for="address_city" class="label">Cidade *</label>
                <input 
                  type="text" 
                  id="address_city"
                  name="address[city]"
                  class="input"
                  value="{{ form.city }}"
                  required
                >
              </div>
              <div>
                <label for="address_zip" class="label">CEP *</label>
                <input 
                  type="text" 
                  id="address_zip"
                  name="address[zip]"
                  class="input"
                  value="{{ form.zip }}"
                  placeholder="00000-000"
                  required
                >
              </div>
            </div>

            <div class="grid grid-cols-1 md-grid-cols-2" style="gap: 1rem;">
              <div>
                <label for="address_province" class="label">Estado *</label>
                <select 
                  id="address_province"
                  name="address[province]"
                  class="input"
                  required
                >
                  <option value="">Selecione o estado</option>
                  {% for state in country.provinces %}
                    <option value="{{ state.code }}" {% if form.province == state.code %}selected{% endif %}>
                      {{ state.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="address_country" class="label">País *</label>
                <select 
                  id="address_country"
                  name="address[country]"
                  class="input"
                  required
                >
                  {{ country_option_tags }}
                </select>
              </div>
            </div>

            <div>
              <label for="address_phone" class="label">Telefone</label>
              <input 
                type="tel" 
                id="address_phone"
                name="address[phone]"
                class="input"
                value="{{ form.phone }}"
                placeholder="(11) 99999-9999"
              >
            </div>

            <div class="flex items-center" style="gap: 0.5rem;">
              <input 
                type="checkbox" 
                id="address_default"
                name="address[default]"
                class="rounded border-border"
                {% if form.default or customer.addresses.size == 0 %}checked{% endif %}
              >
              <label for="address_default" class="text-sm text-foreground">
                Definir como endereço principal
              </label>
            </div>
          </div>

          <div class="flex" style="gap: 0.75rem; margin-top: 1.5rem;">
            <button type="submit" class="btn-primary flex-1">
              <i data-lucide="save" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
              Salvar Endereço
            </button>
            <button type="button" onclick="hideAddressForm()" class="btn-outline">
              Cancelar
            </button>
          </div>
        {% endform %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="hideDeleteModal()"></div>
  <div class="modal-content">
    <div class="text-center">
      <i data-lucide="alert-triangle" style="width: 3rem; height: 3rem; color: hsl(var(--destructive)); margin: 0 auto 1rem;"></i>
      <h3 class="headline text-foreground mb-2" style="font-size: 1.25rem;">Confirmar Exclusão</h3>
      <p class="text-muted-foreground mb-6">
        Tem certeza que deseja excluir este endereço? Esta ação não pode ser desfeita.
      </p>
      
      <div class="flex" style="gap: 0.75rem; justify-content: center;">
        <button onclick="hideDeleteModal()" class="btn-outline">Cancelar</button>
        <button onclick="confirmDelete()" class="btn-destructive">
          <i data-lucide="trash-2" style="width: 1rem; height: 1rem; margin-right: 0.5rem;"></i>
          Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background: hsl(var(--card));
  border-radius: 0.75rem;
  padding: 2rem;
  max-width: 28rem;
  width: 100%;
  position: relative;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.btn-destructive {
  background: hsl(var(--destructive));
  color: hsl(var(--destructive-foreground));
  border: 1px solid hsl(var(--destructive));
  border-radius: 0.5rem;
  padding: 0.75rem 1.5rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
}

.btn-destructive:hover {
  background: hsl(var(--destructive) / 0.9);
}
</style>

<script>
let deleteAddressId = null;

function showAddressForm() {
  document.getElementById('addressForm').style.display = 'block';
  document.getElementById('formTitle').textContent = 'Novo Endereço';
  document.getElementById('addressForm').scrollIntoView({ behavior: 'smooth' });
}

function hideAddressForm() {
  document.getElementById('addressForm').style.display = 'none';
}

function editAddress(addressId) {
  // For simplicity, we'll redirect to the edit page
  // In a more complex implementation, you could populate the form with existing data
  window.location.href = `/account/addresses/${addressId}`;
}

function deleteAddress(addressId) {
  deleteAddressId = addressId;
  document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  deleteAddressId = null;
}

function confirmDelete() {
  if (deleteAddressId) {
    // Create and submit delete form
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/account/addresses/${deleteAddressId}`;
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'delete';
    
    form.appendChild(methodInput);
    document.body.appendChild(form);
    form.submit();
  }
}

// Initialize Lucide icons when page loads
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
});
</script>
